<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Cashflow â€” Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- App scripts -->
  <script type="module" src="js/theme.js" defer></script>
  <script type="module" src="js/auth-guard.js" defer></script>
  <script type="module" src="js/dashboard.js" defer></script>
  <script type="module" src="js/loader.js" defer></script>
</head>
<body>
  <div class="container" id="app">

    <!-- Header -->
    <header class="header" role="banner">
      <div>
        <h1>ðŸ’¸ Cashflow â€” Dashboard</h1>
        <small>Overview of your cash book</small>
      </div>

      <nav class="nav" role="navigation" aria-label="Main">
        <a href="index.html" class="ghost" aria-current="page">Dashboard</a>
        <a href="add.html" class="button">Add Entry</a>
        <a href="entries.html" class="ghost">Entries</a>
      </nav>
    </header>

    <!-- Filters / Controls -->
    <section class="panel no-print" aria-label="Filters">
      <div class="flex items-center gap-4" style="flex-wrap: wrap;">
        <label>
          <span>Range</span>
          <select id="dashRange" aria-label="Select range">
            <option value="MONTH">This Month</option>
            <option value="YEAR">Last 12 Months</option>
            <option value="ALL">All Time</option>
            <option value="CUSTOM">Custom Range</option>
          </select>
        </label>

        <label>
          <span>From</span>
          <input type="date" id="dashFrom" aria-label="From date" />
        </label>

        <label>
          <span>To</span>
          <input type="date" id="dashTo" aria-label="To date" />
        </label>

        <div class="flex gap-2" style="margin-top: 24px;">
          <button id="dashApply" class="ghost">Apply</button>
          <button id="dashReset" class="ghost">Reset</button>
        </div>

        <div style="margin-left:auto;" class="flex gap-2 items-center">
          <label style="align-items: flex-end;">
            <span>Show categories for</span>
            <select id="catFlow" aria-label="Show categories for">
              <option value="IN">IN</option>
              <option value="OUT">OUT</option>
              <option value="ALL">ALL</option>
            </select>
          </label>
        </div>
      </div>
    </section>

    <!-- Top cards -->
    <section class="cards" aria-label="Top metrics">
      <!-- Card 1 -->
      <div class="card card-metric" role="group" aria-label="Today in">
        <div class="card-row">
          <div>
            <p class="card-label">Today (IN)</p>
            <h2 id="tdIn" class="card-value">â‚¹0.00</h2>
            <div class="card-meta">
              <span id="tdInChange" class="trend up" aria-hidden="true">â€”</span>
              <small class="muted">vs yesterday</small>
            </div>
          </div>
          <div class="card-spark">
            <canvas id="sparkTdIn" width="120" height="36" aria-hidden="true"></canvas>
          </div>
        </div>
      </div>

      <!-- Card 2 -->
      <div class="card card-metric" role="group" aria-label="Today out">
        <div class="card-row">
          <div>
            <p class="card-label">Today (OUT)</p>
            <h2 id="tdOut" class="card-value">â‚¹0.00</h2>
            <div class="card-meta">
              <span id="tdOutChange" class="trend down" aria-hidden="true">â€”</span>
              <small class="muted">vs yesterday</small>
            </div>
          </div>
          <div class="card-spark">
            <canvas id="sparkTdOut" width="120" height="36" aria-hidden="true"></canvas>
          </div>
        </div>
      </div>

      <!-- Card 3 -->
      <div class="card card-metric" role="group" aria-label="This month net">
        <div class="card-row">
          <div>
            <p class="card-label">This Month (Net)</p>
            <h2 id="moNet" class="card-value">â‚¹0.00</h2>
            <div class="card-meta">
              <small class="muted">Performance</small>
            </div>
          </div>
          <div class="card-spark">
            <canvas id="sparkMoNet" width="120" height="36" aria-hidden="true"></canvas>
          </div>
        </div>
      </div>

      <!-- Card 4 -->
      <div class="card card-metric" role="group" aria-label="All time net">
        <div class="card-row">
          <div>
            <p class="card-label">All-Time (Net)</p>
            <h2 id="allNet" class="card-value">â‚¹0.00</h2>
            <div class="card-meta">
              <small class="muted">Since inception</small>
            </div>
          </div>
          <div class="card-spark">
            <canvas id="sparkAllNet" width="120" height="36" aria-hidden="true"></canvas>
          </div>
        </div>
      </div>

      <!-- Card 5 -->
      <div class="card card-metric" role="group" aria-label="Closing balance">
        <div class="card-row">
          <div>
            <p class="card-label">All-Time Closing Balance</p>
            <h2 id="allClosing" class="card-value">â‚¹0.00</h2>
            <div class="card-meta">
              <small class="muted">Current balance</small>
            </div>
          </div>
          <div class="card-spark">
            <canvas id="sparkClosing" width="120" height="36" aria-hidden="true"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- Charts & Recent Activity Grid -->
    <div class="dash-grid-lg">

      <!-- Charts Column -->
      <section class="panel charts" aria-label="Financial charts" style="min-width: 0;">
        <div class="flex justify-between items-center mb-4">
          <h3>Financial Charts</h3>
          <small class="muted">Interactive charts â€” hover for details</small>
        </div>

        <div class="charts-grid">
          <div class="chart-card full-width" aria-label="Running balance chart">
            <h4>Running Balance</h4>
            <div class="chart-wrap">
              <canvas id="balanceChart" aria-label="Running balance chart" role="img"></canvas>
            </div>
          </div>

          <div class="chart-card" aria-label="Monthly IN/OUT chart">
            <h4>Monthly IN / OUT (last 12 months)</h4>
            <div class="chart-wrap">
              <canvas id="monthlyChart" aria-label="Monthly in out chart" role="img"></canvas>
            </div>
          </div>

          <div class="chart-card" aria-label="Category breakdown">
            <h4>Category Breakdown</h4>
            <div class="chart-wrap">
              <canvas id="categoryChart" aria-label="Category breakdown chart" role="img"></canvas>
            </div>
          </div>
        </div>
      </section>

      <!-- Recent Activity Column -->
      <section class="panel" aria-label="Recent Activity">
        <div class="flex justify-between items-center mb-4">
          <h3 style="margin:0;border:none">Recent Activity</h3>
          <a href="entries.html" class="ghost" style="padding: 4px 8px; font-size: 12px;">View All</a>
        </div>
        <table class="activity-table">
          <tbody id="recentActivityRows">
            <!-- Populated by JS -->
            <tr><td colspan="3" style="text-align:center;color:var(--muted)">Loading...</td></tr>
          </tbody>
        </table>
      </section>

    </div>

    <!-- Quick Links -->
    <section class="panel no-print" aria-label="Quick links">
      <h3>Quick Links</h3>
      <div class="flex gap-4 flex-wrap mt-4">
        <a class="button ghost" href="entries.html?mode=TODAY">Open Today</a>
        <a class="button ghost" href="entries.html?mode=MONTH">Open This Month</a>
        <a class="button ghost" href="entries.html?mode=ALL">Open All Entries</a>
        <button id="exportDash" class="ghost" style="margin-left:auto">Export Dashboard CSV</button>
      </div>
    </section>

    <footer class="footer" style="text-align: center; color: var(--muted); margin-top: auto;">
      <small>Data stored in Supabase.</small>
    </footer>
  </div>

  <!-- Global Toast -->
  <div id="toast" class="toast" aria-live="polite"></div>

  <!-- Loader -->
  <div class="app-loader" id="appLoader" aria-hidden="true">
    <div class="app-spinner" role="status" aria-label="Loading"></div>
  </div>

  <!-- Small inline helper: sparkline drawer used by dashboard.js if present -->
  <script>
    window.drawSpark = function(canvasId, values) {
      try {
        const c = document.getElementById(canvasId);
        if (!c || !values || !values.length) return;
        const ctx = c.getContext('2d');
        const w = c.width = c.clientWidth; // make canvas pixel size match display
        const h = c.height = c.clientHeight || 36;
        ctx.clearRect(0,0,w,h);
        const max = Math.max(...values), min = Math.min(...values);
        ctx.beginPath();
        values.forEach((v,i)=>{
          const x = (i/(values.length-1 || 1))*w;
          const y = h - ((v - min) / (max - min || 1)) * h;
          if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.strokeStyle = '#4f46e5';
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.lineTo(w,h); ctx.lineTo(0,h); ctx.closePath();
        ctx.fillStyle = 'rgba(79, 70, 229, 0.1)';
        ctx.fill();
      } catch (e) { console.warn('drawSpark error', e); }
    };

    // Trigger a small resize event after load to help Chart.js compute sizes
    window.addEventListener('load', () => {
      setTimeout(()=> window.dispatchEvent(new Event('resize')), 120);
    });
  </script>
</body>
</html>
